name: "Build with Meson and musl-gcc"

on:
  push:
    branches: [ main ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ main ]

jobs:
  Build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Configure dependencies
      run: |
       sudo apt-get install -y python3 python3-pip python3-setuptools python3-wheel ninja-build musl-tools gcc-mingw-w64
       pip3 install meson

    - name: Configure toolchain for Linux
      run: |
       mkdir build
       cd build
       meson --cross-file ../cross-files/musl-static.txt ..
       
    - name: Build project for Linux
      run: |
       cd build
       meson compile
       
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v2
      with:
        name: memorylatency
        path: build/src/memorylatency
       
    - name: Configure toolchain for Windows
      run: |
       cd build
       meson --wipe --cross-file ../cross-files/mingw-w64.txt ..
       
    - name: Build project for Windows
      run: |
       cd build
       meson compile

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v2
      with:
        name: memorylatency.exe
        path: build/src/memorylatency.exe
