name: "Build with Meson"

on:
  push:
    branches: [ main ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ main ]

jobs:
  Build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Configure dependencies
      run: |
       sudo apt install meson ninja-build musl-tools gcc-mingw-w64

    - name: Configure toolchain for Linux
      run: |
       mkdir build
       cd build
       meson --cross-file ../cross-files/musl-static.txt ..
       
    - name: Build project for Linux
      run: |
       cd build
       ninja
       
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v2
      with:
        name: memorylatency
        path: build/src/memorylatency
       
    - name: Configure toolchain for Windows
      run: |
       cd build
       meson --wipe --cross-file ../cross-files/mingw-w64.txt ..
       
    - name: Build project for Windows
      run: |
       cd build
       ninja

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v2
      with:
        name: memorylatency.exe
        path: build/src/memorylatency.exe
